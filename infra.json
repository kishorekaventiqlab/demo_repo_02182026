{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "EC2 Hands-On: Launch EC2 with IAM Role, EBS, Mount Script, and Security Group",
    "Parameters": {
        "KeyName": {
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Description": "Name of an existing EC2 KeyPair to enable SSH access"
        },
        "VpcId": {
            "Type": "AWS::EC2::VPC::Id",
            "Description": "VPC ID for the instance"
        },
        "SubnetId": {
            "Type": "AWS::EC2::Subnet::Id",
            "Description": "Subnet ID for the instance"
        }
    },
    "Mappings": {
        "RegionMap": {
            "ap-south-1": {
                "AMI": "ami-0317b0f0a0144b137"
            },
            "ap-south-2": {
                "AMI": "ami-01cfb0266fc955899"
            }
        }
    },
    "Resources": {
        "InstanceSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable SSH and HTTP access",
                "VpcId": {
                    "Ref": "VpcId"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "EC2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Path": "/",
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "EC2Role"
                    }
                ]
            }
        },
        "MyEBSVolume": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "MyInstance",
                        "AvailabilityZone"
                    ]
                },
                "Size": 8,
                "VolumeType": "gp3",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "MyEBSVolume"
                    }
                ]
            }
        },
        "MyInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "AMI"
                    ]
                },
                "InstanceType": "t2.micro",
                "KeyName": {
                    "Ref": "KeyName"
                },
                "SubnetId": {
                    "Ref": "SubnetId"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "InstanceSG"
                    }
                ],
                "IamInstanceProfile": {
                    "Ref": "EC2InstanceProfile"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n",
                            [
                                "#!/bin/bash",
                                "set -euxo pipefail",
                                "LOG=/var/log/userdata.log",
                                "exec > >(tee -a $LOG|logger -t user-data -s 2>/dev/console) 2>&1",
                                "",
                                "# Get instance metadata token",
                                "TOKEN=$(curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")",
                                "INSTANCE_ID=$(curl -H \"X-aws-ec2-metadata-token: $TOKEN\" -v http://169.254.169.254/latest/meta-data/instance-id)",
                                "",
                                "yum update -y",
                                "yum install -y httpd",
                                "mkdir -p /data",
                                "mkfs.ext4 /dev/xvdf",
                                "mount /dev/xvdf /data",
                                "echo '/dev/xvdf /data ext4 defaults,nofail 0 2' >> /etc/fstab",
                                "systemctl start httpd",
                                "systemctl enable httpd",
                                "echo \"Hello from EC2 with EBS! Instance ID: $INSTANCE_ID\" > /data/index.html"
                            ]
                        ]
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "MyEC2Instance"
                    }
                ]
            }
        },
        "VolumeAttachment": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Properties": {
                "InstanceId": {
                    "Ref": "MyInstance"
                },
                "VolumeId": {
                    "Ref": "MyEBSVolume"
                },
                "Device": "/dev/xvdf"
            }
        }
    },
    "Outputs": {
        "InstanceId": {
            "Description": "EC2 Instance ID",
            "Value": {
                "Ref": "MyInstance"
            }
        },
        "PublicIP": {
            "Description": "Public IP Address",
            "Value": {
                "Fn::GetAtt": [
                    "MyInstance",
                    "PublicIp"
                ]
            }
        },
        "EBSVolumeId": {
            "Description": "EBS Volume ID",
            "Value": {
                "Ref": "MyEBSVolume"
            }
        },
        "RoleName": {
            "Description": "IAM Role Name",
            "Value": {
                "Ref": "EC2Role"
            }
        }
    }
}